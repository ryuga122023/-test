<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログログ　重機点検管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDFとhtml2canvasをCDN経由で読み込む -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, startAt, endAt, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebaseのグローバル変数を安全に取得
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        const inspectionsCollectionPath = `/artifacts/${appId}/users`;
        let currentInspections = [];
        let isInitialized = false;
        let inspectionToProcess = null;
        let inspectionType = '';

        // 重機タイプごとの点検項目を定義（省略せずそのまま）

        const inspectionPresets = {
            // ...（この部分は従来通りそのまま）
            // 省略
            // 全presetオブジェクトはそのまま
        };

        // --- ここからwindow.onload内でDOM取得 ---
        window.onload = async () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // DOM取得はここで（body描画後なのでnullにならない）
            const form = document.getElementById('inspectionForm');
            const companyNameInput = document.getElementById('companyName');
            const machineNameInput = document.getElementById('machineName');
            const machineNumberInput = document.getElementById('machineNumber');
            const inspectionItemsContainer = document.getElementById('inspectionItemsContainer');
            const inspectionsList = document.getElementById('inspectionsList');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const modal = document.getElementById('modal');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const modalMessage = document.getElementById('modalMessage');

            // --- 以降の関数はwindow.onload内で定義 ---
            // 重機名に応じて点検項目を動的に生成する
            const generateInspectionItems = (machineName) => {
                const preset = inspectionPresets[machineName] || [];
                inspectionItemsContainer.innerHTML = '';
                inspectionType = machineName;
                
                if (preset.length > 0) {
                    inspectionItemsContainer.innerHTML = `
                        <h3 class="text-lg font-bold text-gray-800">点検項目</h3>
                        <p class="text-sm text-gray-500 mb-2">※重機名に合わせて項目が自動で変わります</p>
                    `;
                } else {
                    inspectionItemsContainer.innerHTML = `
                        <p class="text-sm text-gray-500 mb-2">※重機を選択してください</p>
                    `;
                }
                
                preset.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.innerHTML = `
                        <label for="item-${index}" class="block text-sm font-medium text-gray-700">${item.name}</label>
                        <input type="text" id="item-${index}" name="item-${index}" placeholder="${item.placeholder}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    `;
                    inspectionItemsContainer.appendChild(itemDiv);
                });
            };

            // ドキュメントデータをHTMLとしてレンダリングする関数
            const renderInspections = (docs) => {
                currentInspections = docs.map(doc => ({ id: doc.id, ...doc.data() }));
                inspectionsList.innerHTML = '';
                if (docs.length === 0) {
                    inspectionsList.innerHTML = '<p class="text-center text-gray-500 mt-4">まだ点検記録がありません。</p>';
                    return;
                }

                docs.forEach(doc => {
                    const data = doc.data();
                    const inspectionId = doc.id;
                    const inspectionItemHtml = (data.items || []).map(item => `
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-semibold">${item.name}:</span>
                            <span class="text-sm">${item.result || ''}</span>
                        </div>
                    `).join('');

                    const itemHtml = `
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${data.machineName}</h3>
                                    <p class="text-sm text-gray-600">重機番号: ${data.machineNumber || 'なし'}</p>
                                    <p class="text-sm text-gray-600">業者名: ${data.companyName}</p>
                                    <p class="text-sm text-gray-600">点検者: ${data.inspectorName}</p>
                                    <p class="text-sm text-gray-600">点検日: ${data.date}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="deleteBtn text-red-500 hover:text-red-700 transition duration-300" data-id="${inspectionId}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg mt-2">
                                <h4 class="font-bold text-gray-700 mb-2">点検項目:</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-gray-700">
                                    ${inspectionItemHtml}
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 mt-2">備考: ${data.notes || 'なし'}</p>
                        </div>
                    `;
                    inspectionsList.innerHTML += itemHtml;
                });

                // イベントリスナーを再設定
                document.querySelectorAll('.deleteBtn').forEach(btn => {
                    btn.onclick = (e) => showDeleteModal(e.currentTarget.dataset.id);
                });
            };

            const showLoading = (show) => {
                loadingIndicator.style.display = show ? 'block' : 'none';
            };

            const showModal = (message, onConfirm) => {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
                confirmBtn.onclick = onConfirm;
            };

            const hideModal = () => {
                modal.classList.add('hidden');
                inspectionToProcess = null;
            };

            const showDeleteModal = (id) => {
                inspectionToProcess = id;
                showModal('本当にこの点検記録を削除しますか？', deleteInspection);
            };
            
            const deleteInspection = async () => {
                if (!inspectionToProcess) return;
                showLoading(true);
                try {
                    await deleteDoc(doc(db, inspectionsCollectionPath, userId, 'inspections', inspectionToProcess));
                    console.log("Record successfully deleted!");
                } catch (error) {
                    console.error("Error deleting document: ", error);
                } finally {
                    hideModal();
                    showLoading(false);
                }
            };

            const saveInspection = async (e) => {
                e.preventDefault();
                showLoading(true);

                const companyName = companyNameInput.value;
                const machineName = machineNameInput.value;
                const machineNumber = machineNumberInput.value; // 重機番号を取得
                const inspectorName = document.getElementById('inspectorName').value;
                const date = document.getElementById('date').value;
                const notes = document.getElementById('notes').value;
                
                if (!machineName) {
                    showLoading(false);
                    return;
                }

                const inspectionItems = [];
                document.querySelectorAll('#inspectionItemsContainer input').forEach(input => {
                    inspectionItems.push({
                        name: input.previousElementSibling.textContent,
                        result: input.value
                    });
                });

                const newInspection = {
                    companyName,
                    machineName,
                    machineNumber, // 重機番号をデータに追加
                    inspectorName,
                    date,
                    notes,
                    items: inspectionItems,
                    createdAt: new Date().toISOString()
                };

                try {
                    await addDoc(collection(db, inspectionsCollectionPath, userId, 'inspections'), newInspection);
                    form.reset();
                    generateInspectionItems(''); // フォームをリセット後、項目をクリア
                    console.log("Inspection added successfully!");
                } catch (error) {
                    console.error("Error adding document: ", error);
                } finally {
                    showLoading(false);
                }
            };

            // PDF保存機能（この関数もwindow.onload内でOK）
            const saveAsPdf = async () => {
                if (currentInspections.length === 0) {
                    showModal('PDFに保存する点検記録がありません。', hideModal);
                    return;
                }

                showLoading(true);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const padding = 10;
                const contentWidth = pageWidth - padding * 2;
                const contentHeight = pageHeight - padding * 2;

                for (let i = 0; i < currentInspections.length; i++) {
                    const inspection = currentInspections[i];
                    
                    // PDFコンテンツ用の仮の要素を作成
                    const pdfContent = document.createElement('div');
                    pdfContent.style.width = `${contentWidth}mm`;
                    pdfContent.style.padding = `${padding}mm`;
                    pdfContent.style.backgroundColor = '#fff';
                    pdfContent.style.fontFamily = 'sans-serif';

                    // ヘッダーとデータを追加
                    let contentHtml = `
                        <h1 style="font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px;">重機点検記録</h1>
                        <div style="border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h3 style="font-size: 16px; font-weight: bold;">${inspection.machineName}</h3>
                            <p style="margin-top: 5px;"><strong>重機番号:</strong> ${inspection.machineNumber || 'なし'}</p>
                            <p><strong>業者名:</strong> ${inspection.companyName || 'N/A'}</p>
                            <p><strong>点検者:</strong> ${inspection.inspectorName || 'N/A'}</p>
                            <p><strong>点検日:</strong> ${inspection.date || 'N/A'}</p>
                            <div style="margin-top: 10px;">
                                <h4 style="font-weight: bold;">点検項目:</h4>
                                <ul style="padding-left: 20px; margin-top: 5px;">
                                    ${inspection.items.map(item => `<li>${item.name}: ${item.result || ''}</li>`).join('')}
                                </ul>
                            </div>
                            <p style="margin-top: 10px;"><strong>備考:</strong> ${inspection.notes || 'なし'}</p>
                        </div>
                    `;
                    pdfContent.innerHTML = contentHtml;

                    // DOMに追加してレンダリング
                    document.body.appendChild(pdfContent);

                    try {
                        const canvas = await html2canvas(pdfContent, { scale: 2 });
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = contentWidth; 
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        if (i > 0) {
                            doc.addPage();
                        }
                        doc.addImage(imgData, 'PNG', padding, padding, imgWidth, imgHeight);

                    } catch (error) {
                        console.error("PDF保存中にエラーが発生しました: ", error);
                        showModal('PDFの保存中にエラーが発生しました。', hideModal);
                        // エラー発生時は処理を中断
                        document.body.removeChild(pdfContent);
                        showLoading(false);
                        return; 
                    } finally {
                        // 仮の要素を削除
                        document.body.removeChild(pdfContent);
                    }
                }
                
                doc.save(`点検記録_${new Date().toISOString().slice(0, 10)}.pdf`);
                showLoading(false);
            };

            // Firebase認証とイベント設定はwindow.onload内でOK
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error: ", error);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    if (!isInitialized) {
                        isInitialized = true;
                        const q = collection(db, inspectionsCollectionPath, userId, 'inspections');
                        onSnapshot(q, (querySnapshot) => {
                            showLoading(true);
                            const inspections = [];
                            querySnapshot.forEach(doc => {
                                inspections.push(doc);
                            });
                            renderInspections(inspections);
                            showLoading(false);
                        }, (error) => {
                            console.error("Error fetching documents: ", error);
                            showLoading(false);
                        });
                    }
                } else {
                    console.log("No user signed in.");
                }
            });

            form.addEventListener('submit', saveInspection);
            cancelBtn.onclick = hideModal;
            document.getElementById('savePdfBtn').onclick = saveAsPdf;
            machineNameInput.addEventListener('change', (e) => {
                const machineName = e.target.value;
                generateInspectionItems(machineName);
            });
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased text-gray-800">
    <!-- body部分は従来通り -->
    <!-- ...省略（フォーム・一覧・モーダルはそのまま）... -->
</body>
</html>